"use strict";const e=require("react/jsx-runtime"),s=require("react"),b=require("./index-DG7KwpzD.cjs");let P=null,L=null;function V(t){return`${t.websocketUrl}|${t.sipUri}|${t.authorizationUser}`}function F(t){const x=V(t);if(P&&L===x)return P;if(P&&L!==x){try{P.ua.stop()}catch{}P=null}L=x;const i={sockets:[new b.JsSIP.WebSocketInterface(t.websocketUrl)],uri:t.sipUri,password:t.password,registrar_server:t.registrarServer,display_name:t.displayName,authorization_user:t.authorizationUser,connection_recovery_min_interval:2,connection_recovery_max_interval:30},o=new b.JsSIP.UA(i),f=document.createElement("audio");f.autoplay=!0;const h={ua:o,audio:f,isStarted:!1,listeners:new Set};return o.on("connecting",()=>{h.listeners.forEach(r=>r.onConnecting?.())}),o.on("connected",()=>{h.listeners.forEach(r=>r.onConnected?.())}),o.on("disconnected",()=>{h.listeners.forEach(r=>r.onDisconnected?.())}),o.on("registered",()=>{h.listeners.forEach(r=>r.onRegistered?.())}),o.on("unregistered",()=>{h.listeners.forEach(r=>r.onUnregistered?.())}),o.on("registrationFailed",r=>{h.listeners.forEach(l=>l.onRegistrationFailed?.(r?.cause))}),o.on("newRTCSession",r=>{const l=r.session;l.direction==="outgoing"&&(h.listeners.forEach(d=>d.onNewSession?.(l)),l.connection&&(l.connection.addEventListener("addstream",d=>{var g=document.createElement("audio");d.streams!==void 0&&d.streams.length!==0&&(g.srcObject=d.streams[0],g.play())}),l.connection.addEventListener("track",d=>{var g=document.createElement("audio");g.srcObject=d.streams[0],g.play()})))}),P=h,h}function K(t){t.isStarted||(t.ua.start(),t.isStarted=!0)}function J(t,x){t.listeners.add(x)}function q(t,x){t.listeners.delete(x)}function W(t){return{isReady:t.ua.isRegistered(),isConnected:t.ua.isConnected()}}const B=s.createContext(null);function _({config:t,children:x,onCallStart:u,onCallEnd:i,onStatusChange:o}){const[f,h]=s.useState(""),[r,l]=s.useState("disconnected"),[d,g]=s.useState(null),[k,w]=s.useState(0),[a,H]=s.useState([]),[j,m]=s.useState(!1),[S,N]=s.useState("connecting"),v=s.useRef(null),p=s.useRef(null),U=s.useRef(null);s.useEffect(()=>{p.current=d},[d]),s.useEffect(()=>{const n=F(t);U.current=n;const y=W(n);y.isReady?(m(!0),N("connected")):y.isConnected&&N("connected");const I={onConnecting:()=>N("connecting"),onConnected:()=>N("connected"),onDisconnected:()=>{N("disconnected"),m(!1)},onRegistered:()=>{m(!0),N("connected")},onUnregistered:()=>m(!1),onRegistrationFailed:E=>{console.error("Registration failed:",E),m(!1),N("failed")},onNewSession:E=>{v.current=E}};return J(n,I),K(n),()=>{q(n,I)}},[t.websocketUrl,t.sipUri,t.password,t.registrarServer,t.displayName,t.authorizationUser]),s.useEffect(()=>{o?.(r)},[r,o]),s.useEffect(()=>{const n=localStorage.getItem("tbi-phone-call-history");if(n)try{H(JSON.parse(n))}catch(y){console.error("Error loading call history",y)}},[]),s.useEffect(()=>{a.length>0&&localStorage.setItem("tbi-phone-call-history",JSON.stringify(a))},[a]),s.useEffect(()=>{if(r==="confirmed"&&d){const n=setInterval(()=>{w(Math.floor((Date.now()-d)/1e3))},1e3);return()=>clearInterval(n)}else w(0)},[r,d]),s.useEffect(()=>{const n=y=>{const I=y.detail.number;r==="disconnected"&&z(I)};return window.addEventListener("StartCallEvent",n),()=>{window.removeEventListener("StartCallEvent",n)}},[r]);const R=s.useCallback((n,y,I)=>{const E={id:Date.now().toString(),number:n,timestamp:Date.now(),duration:y,status:I};H(C=>[E,...C].slice(0,50))},[]),M=s.useCallback(()=>{v.current&&(v.current.terminate(),v.current=null)},[]),z=s.useCallback(n=>{const y=U.current;if(!n.trim()||!y)return;if(!j){console.warn("Phone is not ready yet. Please wait for registration.");return}h(n),u?.(n);const E={eventHandlers:{progress:()=>{l("progress")},failed:C=>{console.error("Call failed:",C?.cause),l("failed"),R(n,0,"failed"),i?.(n,0,"failed"),v.current=null,setTimeout(()=>l("disconnected"),3e3)},ended:()=>{l("ended");const C=p.current,A=C?Math.floor((Date.now()-C)/1e3):0;R(n,A,"completed"),i?.(n,A,"completed"),v.current=null,setTimeout(()=>{l("disconnected"),g(null)},2e3)},confirmed:()=>{l("confirmed"),g(Date.now())}},mediaConstraints:{audio:!0,video:!1}};l("progress");try{const C=y.ua.call(n,E);v.current=C}catch(C){console.error("Failed to start call:",C),l("failed"),R(n,0,"failed"),setTimeout(()=>l("disconnected"),3e3)}},[R,u,i,j]),c={status:r,callNumber:f,setCallNumber:h,callHistory:a,currentCallDuration:k,startCall:z,endCall:M,isReady:j,connectionStatus:S};return e.jsx(B.Provider,{value:c,children:x})}function $(){const t=s.useContext(B);if(!t)throw new Error("usePhone must be used within a PhoneProvider");return t}const T=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"})}),G=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M15.05 5A7 7 0 0 1 19 8.95M15.05 1A11 11 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"})}),Q=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.12-.74-.03-1.02.24l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1zM19 12h2c0-4.97-4.03-9-9-9v2c3.87 0 7 3.13 7 7zm-4 0h2c0-2.76-2.24-5-5-5v2c1.66 0 3 1.34 3 3z"})}),D=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.67-1.85.996.996 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"})}),O=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M6.5 5.5 12 11l7-7-1-1-6 6-4.5-4.5H11V3H5v6h1.5V5.5zm17.21 11.17C20.66 13.78 16.54 12 12 12 7.46 12 3.34 13.78.29 16.67c-.18.18-.29.43-.29.71s.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73 1.6 0 3.15.25 4.6.72v3.1c0 .39.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71s-.12-.52-.3-.7z"})}),X=({className:t})=>e.jsxs("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"}),e.jsx("path",{d:"M16 3l-5 5-2-2-1.5 1.5L11 11l6.5-6.5z"})]}),Y=({className:t})=>e.jsxs("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"}),e.jsx("path",{d:"M19 6.41L17.59 5 15 7.59 12.41 5 11 6.41 13.59 9 11 11.59 12.41 13 15 10.41 17.59 13 19 11.59 16.41 9z"})]}),Z=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"})}),ee=({className:t})=>e.jsx("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})});function te({className:t,labels:x}){const{status:u,callNumber:i,setCallNumber:o,callHistory:f,currentCallDuration:h,startCall:r,endCall:l,isReady:d,connectionStatus:g}=$(),[k,w]=s.useState(!1),a={...b.defaultLabels,...x},j=(()=>{switch(u){case"progress":return{text:`${a.calling}...`,color:"text-yellow-500",Icon:G};case"confirmed":return{text:`${a.inCall} - ${b.formatDuration(h)}`,color:"text-green-500",Icon:Q};case"failed":return{text:a.callEnded,color:"text-red-500",Icon:O};case"ended":return{text:a.callEnded,color:"text-gray-500",Icon:D};default:return{text:a.inactive,color:"text-gray-300",Icon:T}}})();return e.jsxs("div",{className:b.cn("tbi-phone w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg border border-gray-200 p-2",t),children:[u==="disconnected"&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>w(!0),className:"h-8 w-8 flex items-center justify-center rounded-xl border border-gray-200 hover:bg-gray-50 transition-colors",type:"button",children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx("input",{type:"text",value:i,onChange:m=>o(m.target.value),onKeyDown:m=>{m.key==="Enter"&&r(i)},placeholder:a.placeholder,className:"flex-1 w-full h-8 px-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"}),e.jsx("button",{onClick:()=>r(i),disabled:i.length<9||!d,className:"h-8 w-8 flex items-center justify-center rounded-xl bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white transition-colors",type:"button",title:d?"Call":"Connecting...",children:g==="connecting"?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(T,{className:"w-4 h-4"})})]}),u==="progress"&&e.jsxs("div",{className:"flex flex-col items-center gap-3 py-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(j.Icon,{className:"w-12 h-12 text-yellow-500 animate-pulse"}),e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-yellow-500/30 animate-ping"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-base font-semibold",children:[a.calling," ",i]}),e.jsx("p",{className:"text-sm text-gray-500",children:a.waitingResponse})]}),e.jsxs("button",{onClick:l,className:"flex items-center gap-2 px-6 py-2 rounded-full bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors",type:"button",children:[e.jsx(D,{className:"w-4 h-4"}),a.cancel]})]}),u==="confirmed"&&e.jsxs("div",{className:"flex flex-col items-center gap-4 py-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(j.Icon,{className:"w-12 h-12 text-green-500"}),e.jsx("div",{className:"absolute inset-0 rounded-full bg-green-500/20 animate-pulse"})]}),e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("p",{className:"text-xl font-bold",children:i}),e.jsx("p",{className:"text-2xl font-mono text-green-600 tabular-nums",children:b.formatDuration(h)})]}),e.jsxs("button",{onClick:l,className:"flex items-center gap-2 px-6 py-2 rounded-full bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors",type:"button",children:[e.jsx(D,{className:"w-4 h-4"}),a.hangUp]})]}),(u==="failed"||u==="ended")&&e.jsxs("div",{className:"flex flex-col items-center gap-3 py-6",children:[e.jsx(j.Icon,{className:b.cn("w-12 h-12",u==="failed"?"text-red-500":"text-gray-500")}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-base font-semibold",children:j.text})})]}),k&&e.jsxs("div",{className:"fixed inset-0 z-50 flex",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50",onClick:()=>w(!1)}),e.jsx("div",{className:"fixed right-0 top-0 h-full w-full max-w-md bg-white shadow-xl",style:{backgroundColor:"white"},children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:a.callHistory}),e.jsx("p",{className:"text-sm text-gray-500",children:f.length===0?a.noCallsRegistered:`${f.length} ${a.callsRegistered}`})]}),e.jsx("button",{onClick:()=>w(!1),className:"h-8 w-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors",type:"button",children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:f.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(D,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:a.noCalls})]}):e.jsx("div",{className:"space-y-2",children:f.map((m,S)=>e.jsx(se,{entry:m,index:S,onCall:()=>{o(m.number),w(!1),r(m.number)}},m.id))})})]})})]})]})}function se({entry:t,index:x,onCall:u}){const i=()=>{switch(t.status){case"completed":return e.jsx(X,{className:"w-4 h-4 text-green-600"});case"failed":return e.jsx(Y,{className:"w-4 h-4 text-red-600"});case"missed":return e.jsx(O,{className:"w-4 h-4 text-yellow-600"})}},o=()=>{switch(t.status){case"completed":return"bg-green-100";case"failed":return"bg-red-100";case"missed":return"bg-yellow-100"}};return e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors duration-200",style:{animationDelay:`${x*30}ms`},children:[e.jsx("div",{className:b.cn("w-9 h-9 rounded-full flex items-center justify-center shrink-0",o()),children:i()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:t.number}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:new Date(t.timestamp).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})}),t.duration>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx("span",{className:"font-mono tabular-nums",children:b.formatDuration(t.duration)})]})]})]}),e.jsx("button",{onClick:u,className:"h-8 w-8 flex items-center justify-center shrink-0 rounded-lg hover:bg-gray-100 transition-colors",type:"button",children:e.jsx(T,{className:"w-4 h-4"})})]})}function ne({config:t,className:x,onCallStart:u,onCallEnd:i,onStatusChange:o,labels:f}){return e.jsx(_,{config:t,onCallStart:u,onCallEnd:i,onStatusChange:o,children:e.jsx(te,{className:x,labels:f})})}function re(t,x={}){const{onCallStart:u,onCallEnd:i,onStatusChange:o,onConnectionChange:f,persistHistory:h=!0,historyKey:r="tbi-phone-call-history"}=x,[l,d]=s.useState("disconnected"),[g,k]=s.useState(""),[w,a]=s.useState([]),[H,j]=s.useState(0),[m,S]=s.useState(!1),[N,v]=s.useState("connecting"),p=s.useRef(null);s.useEffect(()=>{const c=new b.PhoneManager(t,{onStatusChange:n=>{d(n),o?.(n)},onConnectionChange:n=>{v(n),(n==="connected"||n==="disconnected"||n==="failed")&&S(c.state.isReady),f?.(n)},onCallStart:u,onCallEnd:i,onDurationUpdate:j,onHistoryUpdate:a,onRegistered:()=>S(!0),onUnregistered:()=>S(!1)},{persistHistory:h,historyKey:r});return c.initialize(),p.current=c,d(c.state.status),k(c.state.callNumber),a(c.state.callHistory),S(c.state.isReady),v(c.state.connectionStatus),()=>{c.destroy(),p.current=null}},[t.websocketUrl,t.sipUri,t.password,t.registrarServer,t.displayName,t.authorizationUser,h,r]),s.useEffect(()=>{p.current&&p.current.setEvents({onCallStart:u,onCallEnd:i,onStatusChange:c=>{d(c),o?.(c)},onConnectionChange:c=>{v(c),f?.(c)}})},[u,i,o,f]);const U=s.useCallback(c=>{k(c),p.current?.setCallNumber(c)},[]),R=s.useCallback(c=>{p.current?.startCall(c)},[]),M=s.useCallback(()=>{p.current?.endCall()},[]),z=s.useCallback(()=>{p.current?.clearHistory(),a([])},[]);return{status:l,callNumber:g,setCallNumber:U,callHistory:w,clearCallHistory:z,currentCallDuration:H,startCall:R,endCall:M,isReady:m,connectionStatus:N,ua:p.current?.ua??null}}exports.Phone=ne;exports.PhoneProvider=_;exports.usePhone=$;exports.usePhoneManager=re;
